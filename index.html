<!DOCTYPE html>
<html lang="fa">
<head>
<meta charset="UTF-8">
<title>Ø¯Ø±Ø®ÙˆØ§Ø³Øª ÛŒØ¯Ú©â€ŒÚ©Ø´ / Ù…Ú©Ø§Ù†ÛŒÚ© Ø³ÛŒØ§Ø±</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
body { font-family:tahoma; background:#f2f2f2; margin:0; direction: rtl; }
form { max-width:420px; margin:30px auto; background:#fff; padding:20px; border-radius:10px; }
input, select, textarea, button { width:100%; margin-top:10px; padding:10px; }
button { background:#28a745; color:#fff; border:none; cursor:pointer; }

#mapContainer {
  display:none;
  position:fixed;
  top:0; left:0;
  width:100%; height:100%;
  background:#fff;
  z-index:1000;
}

#map { width:100%; height:80%; }

.map-buttons {
  display:flex;
  justify-content:space-around;
  margin:10px;
}

.map-buttons button {
  flex:1;
  margin:0 5px;
  padding:10px;
  border:none;
  border-radius:5px;
  color:#fff;
}

.manual { background:#007bff; }
.current { background:#ffc107; color:#000; }
.close { background:#dc3545; }
</style>
</head>

<body>

<form id="form">
  <h3>Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø®Ø¯Ù…Ø§Øª</h3>

  <select name="service" required>
    <option value="">Ù†ÙˆØ¹ Ø®Ø¯Ù…Ø§Øª</option>
    <option value="ÛŒØ¯Ú©â€ŒÚ©Ø´">ÛŒØ¯Ú©â€ŒÚ©Ø´</option>
    <option value="Ù…Ú©Ø§Ù†ÛŒÚ© Ø³ÛŒØ§Ø±">Ù…Ú©Ø§Ù†ÛŒÚ© Ø³ÛŒØ§Ø±</option>
  </select>

  <input name="name" placeholder="Ù†Ø§Ù…" required>
  <input name="phone" placeholder="Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³" required>
  <input name="plate" placeholder="Ø´Ù…Ø§Ø±Ù‡ Ù¾Ù„Ø§Ú©" required>
  <textarea name="desc" placeholder="ØªÙˆØ¶ÛŒØ­ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)"></textarea>

  <input type="hidden" id="lat">
  <input type="hidden" id="lon">

  <button type="button" onclick="openMap()">ğŸ“ Ø§Ù†ØªØ®Ø§Ø¨ Ù…ÙˆÙ‚Ø¹ÛŒØª</button>
  <button type="submit">Ø§Ø±Ø³Ø§Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øª</button>
</form>

<!-- Ù†Ù‚Ø´Ù‡ -->
<div id="mapContainer">
  <div class="map-buttons">
    <button class="manual" onclick="manualSelect()">ğŸ–±ï¸ Ø§Ù†ØªØ®Ø§Ø¨ Ø¯Ø³ØªÛŒ</button>
    <button class="current" onclick="useCurrentLocation()">ğŸ“Œ Ù…ÙˆÙ‚Ø¹ÛŒØª ÙØ¹Ù„ÛŒ</button>
    <button class="close" onclick="closeMap()">âœ– Ø¨Ø³ØªÙ†</button>
  </div>
  <div id="map"></div>
</div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
let map, marker;
let manualMode = false;

function openMap() {
  document.getElementById('mapContainer').style.display = 'block';

  if (!map) {
    map = L.map('map').setView([35.6892, 51.3890], 12);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: 'Â© OpenStreetMap'
    }).addTo(map);

    map.on('click', function(e) {
      if (!manualMode) return;

      setMarker(e.latlng.lat, e.latlng.lng);
      manualMode = false;
      alert('Ù…ÙˆÙ‚Ø¹ÛŒØª Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯');
      closeMap();
    });
  }

  setTimeout(() => map.invalidateSize(), 200);
}

function closeMap() {
  document.getElementById('mapContainer').style.display = 'none';
}

function manualSelect() {
  manualMode = true;
  alert('Ø±ÙˆÛŒ Ù†Ù‚Ø´Ù‡ Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯');
}

function setMarker(lat, lng) {
  document.getElementById('lat').value = lat;
  document.getElementById('lon').value = lng;

  if (marker) map.removeLayer(marker);
  marker = L.marker([lat, lng]).addTo(map);
}

function useCurrentLocation() {
  if (!navigator.geolocation) {
    alert('Ù…Ø±ÙˆØ±Ú¯Ø± Ø´Ù…Ø§ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ù…ÛŒâ€ŒÚ©Ù†Ø¯');
    return;
  }

  navigator.geolocation.getCurrentPosition(pos => {
    const lat = pos.coords.latitude;
    const lng = pos.coords.longitude;

    map.setView([lat, lng], 16);
    setMarker(lat, lng);
    closeMap();
  }, () => {
    alert('Ø¯Ø±ÛŒØ§ÙØª Ù…ÙˆÙ‚Ø¹ÛŒØª Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯');
  });
}

// Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ ÙØ±Ù…
document.getElementById('form').addEventListener('submit', function(e) {
  if (!lat.value || !lon.value) {
    e.preventDefault();
    alert('Ù„Ø·ÙØ§Ù‹ Ù…ÙˆÙ‚Ø¹ÛŒØª Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯');
  }
});
</script>

</body>
</html>
